#!/usr/bin/env bash

set -eo pipefail

zecret="$CODEDIR/teammgmt/bin/zecret"

################################################################################

export AWS_PAGER=""

account="dev"
role="DevOps"

if [[ -n "$1" ]]; then
  account="$1"
fi

if [[ -n "$2" ]]; then
  role="$2"
fi

if [[ $# -gt 2 ]]; then
  >&2 echo "Usage: $0 ACCOUNT ROLE"
  exit 1
fi

export AWS_PROFILE="kevel-$account-$role"

# Automate popping a browser open to log in via SSO, only if I'm not already
# logged in.
aws sts get-caller-identity >/dev/null 2>/dev/null \
  || aws sso login

# Ensure that the AWS environment variables (AWS_ACCESS_KEY_ID et al) are set,
# since `pacs` doesn't work with SSO and needs those env vars set instead.
eval "$(aws configure export-credentials --format env)"

################################################################################

ADZERK_SLACK_TOKEN="$("$zecret" ADZERK_SLACK_TOKEN || echo "")"
export ADZERK_SLACK_TOKEN

SHORTCUT_API_TOKEN="$("$zecret" KEVEL_CLUBHOUSE_API_TOKEN || echo "")"
export SHORTCUT_API_TOKEN

GITHUB_TOKEN="$("$zecret" GITHUB_TOKEN || echo "")"
export GITHUB_TOKEN

################################################################################

if [[ "$SHELL" != *"fish" ]]; then
  >&2 echo "WARN: Expected SHELL to be fish, but it's not! Uh-oh..."
fi
# NOTE: ssh-init is defined in ssh.fish
"$SHELL" -i -C ssh-init
